<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ERR toimetuse puhkused</title>
  
  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Babel (JSX kompileerimiseks brauseris) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body {
      font-family: 'Fira Sans', sans-serif;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #a7f3d0;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- AUTONOOMSED IKOONID ---
    const IconTrash2 = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
    );
    const IconGripHorizontal = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="9" r="1"/><circle cx="19" cy="9" r="1"/><circle cx="5" cy="9" r="1"/><circle cx="12" cy="15" r="1"/><circle cx="19" cy="15" r="1"/><circle cx="5" cy="15" r="1"/></svg>
    );
    const IconAlertTriangle = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
    );
    const IconSave = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    );
    const IconLoader2 = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
    );
    const IconCloudOff = ({size=24, className=""}) => (
      <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 2 20 20"/><path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.306-.193"/><path d="M21.532 16.5A4.5 4.5 0 0 0 17.5 10h-1.79A7.008 7.008 0 0 0 10 5.07"/></svg>
    );

    // --- KONFIGURATSIOON ---
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwMgwz2tQWY61JybbJuFr3qyaKNtIrCaBmxP3x7m6lfd-bXedpKVWv5DVBIoLSzmep6/exec'; 

    const MONTHS = [
      { name: 'Mai', span: 3, start: 20, end: 22 },
      { name: 'Juuni', span: 4, start: 23, end: 26 },
      { name: 'Juuli', span: 5, start: 27, end: 31 },
      { name: 'August', span: 4, start: 32, end: 35 },
      { name: 'September', span: 3, start: 36, end: 38 },
    ];

    const WEEKS = Array.from({ length: 19 }, (_, i) => i + 20);
    const MONTH_BOUNDARIES = [22, 26, 31, 35];

    const getWeekDateRange = (weekNo, year = 2026) => {
      const jan4 = new Date(year, 0, 4);
      const day = jan4.getDay() || 7;
      const week1Monday = new Date(year, 0, 4 - day + 1);
      const targetMonday = new Date(week1Monday.getTime() + (weekNo - 1) * 7 * 24 * 60 * 60 * 1000);
      const targetSunday = new Date(targetMonday.getTime() + 6 * 24 * 60 * 60 * 1000);
      
      const format = (d) => `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
      return `${format(targetMonday)}-${format(targetSunday)}`;
    };

    function App() {
      const [employees, setEmployees] = useState([]);
      const [newName, setNewName] = useState('');
      
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      const [syncStatus, setSyncStatus] = useState(null);

      useEffect(() => {
        if (GOOGLE_SHEETS_URL === 'https://script.google.com/macros/s/AKfycbwMgwz2tQWY61JybbJuFr3qyaKNtIrCaBmxP3x7m6lfd-bXedpKVWv5DVBIoLSzmep6/exec') {
          setIsLoading(false);
          return; 
        }

        fetch(GOOGLE_SHEETS_URL)
          .then(res => res.json())
          .then(data => {
            if (Array.isArray(data)) {
              setEmployees(data);
            }
          })
          .catch(err => {
            console.error("Viga andmete laadimisel:", err);
            setSyncStatus('error');
          })
          .finally(() => setIsLoading(false));
      }, []);

      const saveToCloud = async () => {
        if (GOOGLE_SHEETS_URL === 'https://script.google.com/macros/s/AKfycbwMgwz2tQWY61JybbJuFr3qyaKNtIrCaBmxP3x7m6lfd-bXedpKVWv5DVBIoLSzmep6/exec') {
          alert("Seadista esmalt Google Sheets URL koodis (rida 85).");
          return;
        }

        setIsSaving(true);
        setSyncStatus(null);
        try {
          const response = await fetch(GOOGLE_SHEETS_URL, {
            method: 'POST',
            body: JSON.stringify(employees),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' } 
          });
          
          const result = await response.json();
          if (result.status === 'ok') {
            setSyncStatus('success');
            setTimeout(() => setSyncStatus(null), 3000); 
          } else {
            throw new Error("Salvestamine ebaõnnestus serveris");
          }
        } catch (err) {
          console.error("Viga salvestamisel:", err);
          setSyncStatus('error');
        } finally {
          setIsSaving(false);
        }
      };

      const addEmployee = (e) => {
        e.preventDefault();
        const cleanName = newName.trim();
        if (!cleanName) return;
        
        const newEmp = {
          id: crypto.randomUUID(),
          name: cleanName,
          vacations: [
            { id: 'v1', len: 2, color: 'bg-emerald-600 border-emerald-700 text-white hover:bg-emerald-500 shadow-md', label: '2N', startWeek: null },
            { id: 'v2', len: 1, color: 'bg-teal-500 border-teal-600 text-white hover:bg-teal-400 shadow-md', label: '', startWeek: null },
            { id: 'v3', len: 1, color: 'bg-teal-500 border-teal-600 text-white hover:bg-teal-400 shadow-md', label: '', startWeek: null },
            { id: 'v4', len: 1, color: 'bg-teal-500 border-teal-600 text-white hover:bg-teal-400 shadow-md', label: '', startWeek: null }
          ]
        };
        
        setEmployees([...employees, newEmp]);
        setNewName('');
      };

      const removeEmployee = (id) => {
        setEmployees(employees.filter(emp => emp.id !== id));
      };

      const handleDragStart = (e, empId, vacId, len) => {
        e.dataTransfer.setData('application/json', JSON.stringify({ empId, vacId, len }));
      };

      const handleDropOnGrid = (e, targetEmpId, targetWeek) => {
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData('application/json'));
          if (data.empId !== targetEmpId) return;
          if (targetWeek + data.len - 1 > 38) return;

          setEmployees(employees.map(emp => {
            if (emp.id !== targetEmpId) return emp;
            const overlap = emp.vacations.some(v => {
              if (v.id === data.vacId || v.startWeek === null) return false;
              const start1 = targetWeek;
              const end1 = targetWeek + data.len - 1;
              const start2 = v.startWeek;
              const end2 = v.startWeek + v.len - 1;
              return Math.max(start1, start2) <= Math.min(end1, end2);
            });

            if (overlap) return emp;

            return {
              ...emp,
              vacations: emp.vacations.map(v => 
                v.id === data.vacId ? { ...v, startWeek: targetWeek } : v
              )
            };
          }));
        } catch (err) {
          console.error(err);
        }
      };

      const handleDropOnSidebar = (e) => {
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData('application/json'));
          setEmployees(employees.map(emp => {
            if (emp.id === data.empId) {
              return {
                ...emp,
                vacations: emp.vacations.map(v => 
                  v.id === data.vacId ? { ...v, startWeek: null } : v
                )
              };
            }
            return emp;
          }));
        } catch (err) {
          console.error(err);
        }
      };

      const allowDrop = (e) => e.preventDefault();

      const getAbsenceCount = (week) => {
        return employees.filter(emp => 
          emp.vacations.some(v => v.startWeek !== null && week >= v.startWeek && week < v.startWeek + v.len)
        ).length;
      };

      const getHeaderColorClass = (count) => {
        if (count >= 5) return 'bg-rose-900 text-white border-rose-950 font-bold';
        if (count === 4) return 'bg-rose-500 text-white border-rose-600 font-bold';
        if (count === 3) return 'bg-amber-400 text-emerald-950 border-amber-500 font-bold';
        return 'bg-emerald-50 text-emerald-800 border-emerald-200';
      };

      if (isLoading) {
        return (
          <div className="flex h-screen w-full items-center justify-center bg-emerald-50 text-emerald-900">
            <IconLoader2 className="animate-spin mr-3" size={24} />
            Andmestiku laadimine serverist...
          </div>
        );
      }

      return (
        <div className="flex h-screen w-full bg-emerald-100/40 text-sm text-emerald-950 overflow-hidden">
          
          {/* TÖÖLAUD / SIDEBAR */}
          <div 
            className="w-80 bg-emerald-50/80 border-r border-emerald-200 flex flex-col p-5 z-10 shadow-[4px_0_24px_-10px_rgba(0,0,0,0.1)] backdrop-blur-sm"
            onDragOver={allowDrop}
            onDrop={handleDropOnSidebar}
          >
            <div className="flex justify-between items-start mb-6">
              <h1 className="text-2xl font-bold text-emerald-900 tracking-tight leading-none">
                Puhkuste<br/>planeerija
              </h1>
              
              <button
                onClick={saveToCloud}
                disabled={isSaving}
                className={`flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-semibold shadow-sm transition-all
                  ${isSaving ? 'bg-emerald-200 text-emerald-600 cursor-not-allowed' : 
                    syncStatus === 'error' ? 'bg-rose-100 text-rose-700 hover:bg-rose-200' :
                    syncStatus === 'success' ? 'bg-teal-100 text-teal-700' :
                    'bg-emerald-600 text-white hover:bg-emerald-700 active:scale-95'}`}
              >
                {isSaving ? <IconLoader2 size={14} className="animate-spin" /> : 
                 syncStatus === 'error' ? <IconCloudOff size={14} /> : 
                 <IconSave size={14} />}
                {isSaving ? 'Salvestan...' : 
                 syncStatus === 'error' ? 'Viga!' :
                 syncStatus === 'success' ? 'Salvestatud' : 'Salvesta'}
              </button>
            </div>
            
            <form onSubmit={addEmployee} className="flex gap-2 mb-6">
              <input
                type="text"
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                placeholder="Toimetaja nimi..."
                className="flex-1 px-4 py-2 border border-emerald-300 rounded-xl bg-white shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all placeholder:text-emerald-300"
              />
              <button 
                type="submit" 
                className="px-5 py-2 bg-emerald-700 text-white font-semibold rounded-xl hover:bg-emerald-800 transition-colors shadow-md active:scale-95"
              >
                Lisa
              </button>
            </form>

            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
              {employees.length === 0 ? (
                <div className="text-emerald-600/60 italic text-center mt-10">
                  Andmestik on tühi. Täida tabel töötajatega.
                </div>
              ) : (
                employees.map(emp => {
                  const unplacedVacations = emp.vacations.filter(v => v.startWeek === null);
                  
                  return (
                    <div key={emp.id} className="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 mb-4 transition-all hover:shadow-md">
                      <div className="flex justify-between items-center mb-4">
                        <span className="font-semibold text-emerald-900">{emp.name}</span>
                        <button onClick={() => removeEmployee(emp.id)} className="text-emerald-300 hover:text-rose-500 transition-colors">
                          <IconTrash2 size={16} />
                        </button>
                      </div>
                      
                      <div className="flex gap-2 min-h-8">
                        {unplacedVacations.map(v => (
                          <div
                            key={v.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, emp.id, v.id, v.len)}
                            className={`h-8 rounded-lg border flex items-center justify-center cursor-grab active:cursor-grabbing transition-colors ${v.color} ${v.len === 2 ? 'w-16' : 'w-10'}`}
                            title={`Lohista graafikusse (${emp.name}, pikkus: ${v.len} nädalat)`}
                          >
                            {v.label && <span className="text-xs font-bold mr-1">{v.label}</span>}
                            <IconGripHorizontal size={14} className="opacity-70" />
                          </div>
                        ))}
                        {unplacedVacations.length === 0 && (
                          <span className="text-xs text-emerald-500/70 flex items-center gap-1 font-medium">
                            Kõik puhkused planeeritud.
                          </span>
                        )}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
            
            <div className="mt-4 p-4 bg-emerald-100/50 rounded-xl text-xs text-emerald-800 shadow-inner border border-emerald-200/50 leading-relaxed">
              <IconAlertTriangle size={16} className="inline mr-1.5 mb-1 text-emerald-600" />
              Salvestamiseks vajuta üleval nuppu. Automaatselt midagi ei salvestu.
            </div>
          </div>

          {/* PÕHIGRAAFIK */}
          <div className="flex-1 overflow-auto relative p-6">
            <div className="min-w-max bg-white rounded-2xl shadow-xl border border-emerald-100 overflow-hidden">
              <table className="border-collapse w-full">
                <thead className="sticky top-0 z-20 bg-emerald-50 shadow-sm">
                  <tr>
                    <th className="border-b border-r border-emerald-200 p-2 w-48 bg-emerald-100/50"></th>
                    {MONTHS.map(month => (
                      <th key={month.name} colSpan={month.span} className="border-b border-r border-emerald-200 py-2 text-center font-bold text-emerald-800 tracking-widest text-xs uppercase bg-emerald-50/80">
                        {month.name}
                      </th>
                    ))}
                  </tr>
                  <tr>
                    <th className="border-b border-r border-emerald-200 p-3 text-left bg-emerald-100/50 text-emerald-900 font-semibold sticky left-0 z-30 shadow-[1px_0_0_0_#a7f3d0]">
                      Toimetaja
                    </th>
                    {WEEKS.map(week => {
                      const absenceCount = getAbsenceCount(week);
                      const isBoundary = MONTH_BOUNDARIES.includes(week);
                      // Tükeldame kuupäevade stringi sidekriipsu kohalt
                      const [startDate, endDate] = getWeekDateRange(week).split('-');
                      
                      return (
                        <th 
                          key={week} 
                          className={`border-b border-emerald-200 px-1 py-3 text-center min-w-[64px] transition-colors ${getHeaderColorClass(absenceCount)} ${isBoundary ? 'border-r-2 border-r-emerald-300' : 'border-r border-r-emerald-100'}`}
                          title={`${absenceCount} toimetaja(t) puhkusel`}
                        >
                          <div className="text-xs font-bold opacity-90 mb-1 pb-1 border-b border-black/10 mx-1">N {week}</div>
                          <div className="text-xs font-medium opacity-80 leading-snug">
                            {startDate}<br/>{endDate}
                          </div>
                          {absenceCount > 0 && (
                            <div className="text-xs mt-2 bg-black/15 rounded-full w-5 h-5 mx-auto flex items-center justify-center font-bold shadow-sm">
                              {absenceCount}
                            </div>
                          )}
                        </th>
                      );
                    })}
                  </tr>
                </thead>
                
                <tbody className="bg-white">
                  {employees.length === 0 && (
                    <tr>
                      <td colSpan={WEEKS.length + 1} className="p-12 text-center text-emerald-400 font-medium">
                        Graafik ootab ohvreid.
                      </td>
                    </tr>
                  )}
                  {employees.map(emp => (
                    <tr key={emp.id} className="hover:bg-emerald-50/50 transition-colors group">
                      <td className="border-b border-r border-emerald-100 px-4 py-3 font-medium text-emerald-900 sticky left-0 bg-white group-hover:bg-emerald-50 z-10 shadow-[1px_0_0_0_#d1fae5]">
                        {emp.name}
                      </td>
                      {WEEKS.map(week => {
                        const isBoundary = MONTH_BOUNDARIES.includes(week);
                        const activeVacation = emp.vacations.find(v => v.startWeek === week);
                        const isCovered = emp.vacations.some(v => v.startWeek !== null && week >= v.startWeek && week < v.startWeek + v.len);
                        
                        return (
                          <td 
                            key={`${emp.id}-${week}`}
                            className={`border-b border-emerald-50 min-w-[64px] h-14 relative p-1.5 ${isBoundary ? 'border-r-2 border-r-emerald-200' : 'border-r border-r-emerald-50'}`}
                            onDragOver={allowDrop}
                            onDrop={(e) => handleDropOnGrid(e, emp.id, week)}
                          >
                            {activeVacation && (
                              <div 
                                draggable
                                onDragStart={(e) => handleDragStart(e, emp.id, activeVacation.id, activeVacation.len)}
                                className={`absolute top-1.5 bottom-1.5 left-1.5 rounded-lg border shadow-sm flex items-center justify-center cursor-grab active:cursor-grabbing z-10 transition-transform hover:scale-[1.02] ${activeVacation.color}`}
                                style={{ width: `calc(${activeVacation.len * 100}% - 12px + ${(activeVacation.len - 1) * 1}px)` }}
                                title="Lohista teise nädalasse või tagasi paneeli"
                              >
                                {activeVacation.label && <span className="text-xs font-bold mr-1.5">{activeVacation.label}</span>}
                                <IconGripHorizontal size={14} className="opacity-60" />
                              </div>
                            )}
                            {!isCovered && (
                              <div className="w-full h-full border-2 border-dashed border-transparent hover:border-emerald-200 rounded-lg transition-colors" />
                            )}
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
